<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>赚钱效应 · Dashboard</title>
  <meta name="description" content="A股赚钱效应：每日风格识别与持续性追踪" />
  <style>
    :root {
      --bg: #0b1020;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --text: #e7eaf2;
      --muted: rgba(231,234,242,.72);
      --line: rgba(255,255,255,.12);
      --brand: #6ee7ff;
      --good: #4ade80;
      --warn: #fbbf24;
      --bad: #fb7185;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(900px 600px at 20% 0%, rgba(110,231,255,.10), transparent 60%),
                  radial-gradient(900px 600px at 80% 10%, rgba(99,102,241,.12), transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    a { color: var(--brand); text-decoration: none; }
    a:hover { text-decoration: underline; }
    header {
      position: sticky;
      top: 0;
      backdrop-filter: blur(10px);
      background: rgba(11,16,32,.65);
      border-bottom: 1px solid var(--line);
      z-index: 10;
    }
    .wrap { max-width: 1120px; margin: 0 auto; padding: 18px 16px; }
    .topbar {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
    }
    .brand {
      display: flex; align-items: baseline; gap: 10px;
    }
    .brand h1 { margin: 0; font-size: 18px; letter-spacing: .2px; }
    .brand .badge { font-size: 12px; color: var(--muted); border: 1px solid var(--line); padding: 2px 8px; border-radius: 999px; }

    .nav { display: flex; gap: 10px; }
    .nav button {
      border: 1px solid var(--line);
      background: transparent;
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
    }
    .nav button[aria-current="page"] { background: var(--panel2); }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      padding: 18px 16px 32px;
      max-width: 1120px;
      margin: 0 auto;
    }
    .card {
      border: 1px solid var(--line);
      background: var(--panel);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
    }
    .card h2 { margin: 0 0 10px; font-size: 14px; color: var(--muted); font-weight: 600; }
    .hero { grid-column: 1 / -1; }
    .hero .headline { font-size: 18px; margin: 0 0 6px; }
    .hero .sub { margin: 0; color: var(--muted); font-size: 13px; }

    .kpi { grid-column: span 3; }
    .kpi .v { font-size: 22px; font-weight: 700; letter-spacing: .2px; }
    .kpi .d { margin-top: 6px; color: var(--muted); font-size: 12px; }

    .half { grid-column: span 6; min-height: 260px; }
    .full { grid-column: 1 / -1; }

    .row { display:flex; align-items: center; justify-content: space-between; gap: 10px; }
    .pill { font-size: 12px; color: var(--muted); border: 1px solid var(--line); padding: 4px 10px; border-radius: 999px; }

    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid rgba(255,255,255,.08); padding: 10px 8px; font-size: 12px; text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    .muted { color: var(--muted); }

    .toolbar { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    input[type="search"], select {
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      outline: none;
    }

    .empty { color: var(--muted); font-size: 13px; padding: 10px 0; }

    @media (max-width: 960px) {
      .kpi { grid-column: span 6; }
      .half { grid-column: 1 / -1; }
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>赚钱效应</h1>
        <span class="badge" id="asof">加载中…</span>
      </div>
      <nav class="nav" aria-label="Primary">
        <button id="tab-today" aria-current="page">今日概览</button>
        <button id="tab-trend">持续性</button>
        <button id="tab-archive">归档</button>
      </nav>
    </div>
  </div>
</header>

<main id="view"></main>

<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script>
  const $ = (sel) => document.querySelector(sel);

  const state = {
    tab: 'today',
    latest: null,
    history: null,
  };

  async function fetchJson(url) {
    const res = await fetch(url, { cache: 'no-cache' });
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${url}`);
    return res.json();
  }

  function fmt(n) {
    if (n == null || Number.isNaN(n)) return '—';
    if (typeof n === 'string') return n;
    return new Intl.NumberFormat('zh-CN').format(n);
  }

  function setTab(tab) {
    state.tab = tab;
    $('#tab-today').setAttribute('aria-current', tab === 'today' ? 'page' : 'false');
    $('#tab-trend').setAttribute('aria-current', tab === 'trend' ? 'page' : 'false');
    $('#tab-archive').setAttribute('aria-current', tab === 'archive' ? 'page' : 'false');
    render();
  }

  function card(title, innerHtml, cls='card') {
    const el = document.createElement('section');
    el.className = cls;
    el.innerHTML = `<h2>${title}</h2>` + innerHtml;
    return el;
  }

  function renderToday() {
    const d = state.latest;
    const root = document.createElement('div');
    root.className = 'grid';

    root.appendChild(card('今日结论', `
      <p class="headline">${d?.conclusion ?? '（待生成）'}</p>
      <p class="sub">建议：先跑通数据/口径与展示结构，图表在 V1 补全。</p>
    `, 'card hero'));

    const kpis = [
      { t: 'Top200 中位市值（元）', v: fmt(d?.kpi?.median_mktcap_cny), d: '市值口径：总市值；分层：<50亿 / 50-200亿 / >200亿' },
      { t: 'Top200 中位成交额（元）', v: fmt(d?.kpi?.median_turnover_cny), d: '分层：>10亿 / 3-10亿 / <3亿' },
      { t: '主导板块', v: d?.kpi?.dominant_board ?? '—', d: '主板（沪深合并）/ 创业板 / 科创板' },
      { t: '主导形态', v: d?.kpi?.dominant_pattern ?? '—', d: '规则识别（V1 迭代阈值）' },
    ];
    for (const k of kpis) {
      const el = document.createElement('section');
      el.className = 'card kpi';
      el.innerHTML = `<h2>${k.t}</h2><div class="v">${k.v}</div><div class="d">${k.d}</div>`;
      root.appendChild(el);
    }

    root.appendChild(card('市值分层分布', `
      <div id="chart-cap" style="height:240px;"></div>
      <div class="muted">分层：微盘&lt;50亿 / 中盘50-200亿 / 大盘&gt;200亿（Top200 样本）。</div>
    `, 'card half'));

    root.appendChild(card('成交额分层分布', `
      <div id="chart-turn" style="height:240px;"></div>
      <div class="muted">分层：&gt;10亿 / 3-10亿 / &lt;3亿（Top200 样本）。</div>
    `, 'card half'));

    root.appendChild(card('形态分布（规则版）', `
      <div id="chart-pattern" style="height:260px;"></div>
      <div class="muted">规则版 v0：连板/首板/低位突破/低位首板（其余为“—”）。</div>
    `, 'card full'));

    // wire charts
    setTimeout(() => {
      const rows = (d?.top200 ?? []).slice();

      function countBy(getKey, order) {
        const m = new Map();
        for (const r of rows) {
          const k = getKey(r) || '—';
          m.set(k, (m.get(k) || 0) + 1);
        }
        const arr = Array.from(m.entries()).map(([k, v]) => ({ k, v }));
        if (order) {
          arr.sort((a,b) => order.indexOf(a.k) - order.indexOf(b.k));
        } else {
          arr.sort((a,b) => b.v - a.v);
        }
        return arr;
      }

      function renderCharts() {
        if (!window.echarts) return;

        const makePie = (el, data, title) => {
          const chart = echarts.init(el);
          chart.setOption({
            backgroundColor: 'transparent',
            tooltip: { trigger: 'item' },
            legend: { top: 8, textStyle: { color: 'rgba(231,234,242,.72)' } },
            series: [{
              name: title,
              type: 'pie',
              radius: ['35%','70%'],
              center: ['50%','60%'],
              avoidLabelOverlap: true,
              itemStyle: { borderColor: 'rgba(11,16,32,.65)', borderWidth: 2 },
              label: { color: 'rgba(231,234,242,.82)' },
              data: data.map(x => ({ name: x.k, value: x.v }))
            }]
          });
          return chart;
        };

        const capData = countBy(r => r.cap_bucket, ['微盘','中盘','大盘','—']);
        const turnData = countBy(r => r.turn_bucket, ['>10亿','3-10亿','<3亿','—']);
        const patData = countBy(r => r.pattern);

        const cap = makePie($('#chart-cap'), capData, '市值分层');
        const turn = makePie($('#chart-turn'), turnData, '成交额分层');
        const pat = makePie($('#chart-pattern'), patData, '形态分布');

        window.addEventListener('resize', () => { cap.resize(); turn.resize(); pat.resize(); }, { passive: true });
      }

      renderCharts();
    }, 0);

    return root;
  }

  function renderTrend() {
    const root = document.createElement('div');
    root.className = 'grid';
    root.appendChild(card('风格持续性（占位）', `
      <div class="muted">V1：显示近20日主导风格表 + 关键指标趋势图。</div>
    `, 'card full'));
    return root;
  }

  function renderArchive() {
    const root = document.createElement('div');
    root.className = 'grid';
    const items = state.history?.dates ?? [];
    root.appendChild(card('历史归档', `
      <div class="muted">点击日期查看当日页面（静态 JSON 驱动）。</div>
      <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:10px;">
        ${items.length ? items.map(d => `<a class="pill" href="?date=${encodeURIComponent(d)}">${d}</a>`).join('') : '<div class="empty">暂无归档（等生成器）。</div>'}
      </div>
    `, 'card full'));
    return root;
  }

  function render() {
    const view = $('#view');
    view.innerHTML = '';
    if (state.tab === 'today') view.appendChild(renderToday());
    else if (state.tab === 'trend') view.appendChild(renderTrend());
    else view.appendChild(renderArchive());
  }

  async function boot() {
    $('#tab-today').addEventListener('click', () => setTab('today'));
    $('#tab-trend').addEventListener('click', () => setTab('trend'));
    $('#tab-archive').addEventListener('click', () => setTab('archive'));

    const url = new URL(location.href);
    const date = url.searchParams.get('date');

    try {
      state.history = await fetchJson('./data/index.json');
    } catch (e) {
      state.history = { dates: [] };
    }

    try {
      if (date) {
        state.latest = await fetchJson(`./data/${date}.json`);
      } else {
        state.latest = await fetchJson('./data/latest.json');
      }
      $('#asof').textContent = `更新：${state.latest?.date ?? '—'}`;
    } catch (e) {
      state.latest = { date: null, conclusion: null, kpi: {}, top200: [] };
      $('#asof').textContent = '未找到数据（请先生成 data/latest.json）';
    }

    render();
  }

  boot();
</script>
</body>
</html>
