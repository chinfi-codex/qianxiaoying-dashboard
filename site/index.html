<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>赚钱效应 · Dashboard</title>
  <meta name="description" content="A股赚钱效应：每日风格识别与持续性追踪" />
  <style>
    :root {
      --bg: #f4f7ff;
      --panel: #ffffff;
      --panel2: #f8fbff;
      --text: #1f2a44;
      --muted: #5c6b8a;
      --line: #dbe4ff;
      --brand: #3b82f6;
      --good: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(900px 600px at 15% -10%, rgba(59,130,246,.15), transparent 60%),
                  radial-gradient(900px 600px at 85% -10%, rgba(16,185,129,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    a { color: var(--brand); text-decoration: none; }
    a:hover { text-decoration: underline; }
    header {
      position: sticky;
      top: 0;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,.88);
      border-bottom: 1px solid var(--line);
      z-index: 10;
    }
    .wrap { max-width: 1120px; margin: 0 auto; padding: 18px 16px; }
    .topbar {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
    }
    .brand {
      display: flex; align-items: baseline; gap: 10px;
    }
    .brand h1 { margin: 0; font-size: 18px; letter-spacing: .2px; }
    .brand .badge { font-size: 12px; color: var(--muted); border: 1px solid var(--line); padding: 2px 8px; border-radius: 999px; }

    .nav { display: flex; gap: 10px; }
    .nav button {
      border: 1px solid var(--line);
      background: transparent;
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
    }
    .nav button[aria-current="page"] { background: var(--panel2); }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      padding: 18px 16px 32px;
      max-width: 1120px;
      margin: 0 auto;
    }
    .card {
      border: 1px solid var(--line);
      background: var(--panel);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 8px 20px rgba(59,130,246,.10);
    }
    .card h2 { margin: 0 0 10px; font-size: 14px; color: var(--muted); font-weight: 600; }
    .hero { grid-column: 1 / -1; }
    .hero .headline { font-size: 18px; margin: 0 0 6px; }
    .hero .sub { margin: 0; color: var(--muted); font-size: 13px; }

    .kpi { grid-column: span 3; }
    .kpi .v { font-size: 22px; font-weight: 700; letter-spacing: .2px; }
    .kpi .d { margin-top: 6px; color: var(--muted); font-size: 12px; }

    .half { grid-column: span 6; min-height: 260px; }
    .third { grid-column: span 4; min-height: 260px; }
    .full { grid-column: 1 / -1; }

    .tiles { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .tile { border: 1px solid rgba(255,255,255,.10); border-radius: 14px; padding: 10px; background: rgba(255,255,255,.04); }
    .tile .name { font-size: 13px; font-weight: 700; margin: 0 0 6px; }
    .tile .meta { font-size: 12px; color: var(--muted); margin: 0 0 8px; }
    .kbox { height: 160px; }

    @media (max-width: 960px) {
      .kpi { grid-column: span 6; }
      .half { grid-column: 1 / -1; }
      .third { grid-column: 1 / -1; }
      .tiles { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px) {
      .tiles { grid-template-columns: 1fr; }
    }

    .row { display:flex; align-items: center; justify-content: space-between; gap: 10px; }
    .pill { font-size: 12px; color: var(--muted); border: 1px solid var(--line); padding: 4px 10px; border-radius: 999px; }

    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid rgba(255,255,255,.08); padding: 10px 8px; font-size: 12px; text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    .muted { color: var(--muted); }

    .toolbar { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
    input[type="search"], select {
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      outline: none;
    }

    .empty { color: var(--muted); font-size: 13px; padding: 10px 0; }

    @media (max-width: 960px) {
      .kpi { grid-column: span 6; }
      .half { grid-column: 1 / -1; }
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>赚钱效应</h1>
        <span class="badge" id="asof">加载中…</span>
      </div>
      <div class="nav" aria-label="Primary">
        <span class="pill">单页复盘模式</span>
      </div>
      <div class="toolbar" style="justify-content:flex-end;">
        <input id="datepick" type="date" />
        <button id="btn-load" class="pill" style="cursor:pointer;">Load</button>
      </div>
    </div>
  </div>
</header>

<main id="view"></main>

<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script>
  const $ = (sel) => document.querySelector(sel);

  const state = {
    latest: null,
    history: null,
    tradeCal: null,
  };

  async function fetchJson(url) {
    const res = await fetch(url, { cache: 'no-cache' });
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${url}`);
    return res.json();
  }

  function fmt(n) {
    if (n == null || Number.isNaN(n)) return '—';
    if (typeof n === 'string') return n;
    return new Intl.NumberFormat('zh-CN').format(n);
  }

  // single-page mode: no tab switcher

  function card(title, innerHtml, cls='card') {
    const el = document.createElement('section');
    el.className = cls;
    el.innerHTML = `<h2>${title}</h2>` + innerHtml;
    return el;
  }

  function renderToday() {
    const d = state.latest;
    const root = document.createElement('div');
    root.className = 'grid';


    const ex = d?.external || {};
    const exRows = [
      { t: 'BTC', v: ex?.btc?.value == null ? '—' : `$${fmt(Math.round(ex.btc.value))}`, d: ex?.btc?.change == null ? '—' : `${Number(ex.btc.change).toFixed(2)}%`, sid: 'btc' },
      { t: 'XAU', v: ex?.xau?.value == null ? '—' : `${Number(ex.xau.value).toFixed(2)}`, d: ex?.xau?.change == null ? '—' : `${Number(ex.xau.change).toFixed(2)}%`, sid: 'xau' },
      { t: 'US10Y', v: ex?.us10y?.value == null ? '—' : `${Number(ex.us10y.value).toFixed(2)}%`, d: ex?.us10y?.change == null ? '—' : `${Number(ex.us10y.change).toFixed(1)}bp`, sid: 'us10y' },
    ];
    root.appendChild(card('1) 外盘数据', `
      <table>
        <thead><tr><th>标的</th><th>数据</th><th>日变动</th><th>120日折线</th></tr></thead>
        <tbody>
          ${exRows.map(r => `<tr><td>${r.t}</td><td>${r.v}</td><td>${r.d}</td><td><div id="chart-ex-${r.sid}" style="height:56px;min-width:180px;"></div></td></tr>`).join('')}
        </tbody>
      </table>
    `, 'card full'));

    root.appendChild(card('2) 大盘数据', `<div class="muted">三大指数K线 + 历史趋势（按 app.py 口径迁移）。</div>`, 'card full'));
    root.appendChild(card('上证指数（近200）', `<div id="chart-idx-sh" style="height:260px;"></div>`, 'card third'));
    root.appendChild(card('创业板指数（近200）', `<div id="chart-idx-cyb" style="height:260px;"></div>`, 'card third'));
    root.appendChild(card('科创板指数（近200）', `<div id="chart-idx-kcb" style="height:260px;"></div>`, 'card third'));
    root.appendChild(card('创业板PE（近500）', `<div id="chart-gem-pe" style="height:260px;"></div>`, 'card full'));

    // 大盘历史趋势图（按 app.py 口径迁移，样式沿用）
    root.appendChild(card('成交额（近30）', `
      <div id="chart-mh-turnover" style="height:260px;"></div>
    `, 'card third'));
    root.appendChild(card('情绪指数/活跃度（近30）', `
      <div id="chart-mh-activity" style="height:260px;"></div>
    `, 'card third'));
    root.appendChild(card('融资净买入（近30）', `
      <div id="chart-mh-fin" style="height:260px;"></div>
    `, 'card third'));

    root.appendChild(card('涨跌家数对比（近30）', `
      <div id="chart-mh-updown" style="height:260px;"></div>
    `, 'card half'));
    root.appendChild(card('涨停/跌停数量（近30）', `
      <div id="chart-mh-limit" style="height:260px;"></div>
    `, 'card half'));

    // wire charts
    setTimeout(() => {
      const rows = (d?.top200 ?? []).slice();

      function countBy(getKey, order) {
        const m = new Map();
        for (const r of rows) {
          const k = getKey(r) || '—';
          m.set(k, (m.get(k) || 0) + 1);
        }
        const arr = Array.from(m.entries()).map(([k, v]) => ({ k, v }));
        if (order) {
          arr.sort((a,b) => order.indexOf(a.k) - order.indexOf(b.k));
        } else {
          arr.sort((a,b) => b.v - a.v);
        }
        return arr;
      }

      function renderCharts() {
        if (!window.echarts) return;

        const mkMini = (el, series) => {
          if (!el) return null;
          const arr = Array.isArray(series) ? series : [];
          const chart = echarts.init(el);
          chart.setOption({
            animation: false,
            grid: { left: 2, right: 2, top: 4, bottom: 2 },
            xAxis: { type: 'category', data: arr.map(x => x.date), show: false },
            yAxis: { type: 'value', show: false, scale: true },
            tooltip: { trigger: 'axis' },
            series: [{ type: 'line', data: arr.map(x => x.value), showSymbol: false, lineStyle: { width: 1.6, color: '#3b82f6' }, areaStyle: { color: 'rgba(59,130,246,.08)' } }]
          });
          return chart;
        };
        const cExBtc = mkMini($('#chart-ex-btc'), ex?.btc?.series || []);
        const cExXau = mkMini($('#chart-ex-xau'), ex?.xau?.series || []);
        const cExUs10 = mkMini($('#chart-ex-us10y'), ex?.us10y?.series || []);

        const normalizeLabel = (k) => {
          if (k == null) return '未归类';
          if (k === '—') return '未归类';
          return k;
        };

        const makeBar = (el, data, title, order) => {
          const items = (data || []).map(x => ({ k: normalizeLabel(x.k), v: x.v || 0 }));
          const hasUnk = items.some(x => x.k === '未归类');
          if (!hasUnk) items.push({ k: '未归类', v: 0 });

          // keep order if provided
          if (order && order.length) {
            const ord = order.map(normalizeLabel);
            items.sort((a,b) => ord.indexOf(a.k) - ord.indexOf(b.k));
          } else {
            items.sort((a,b) => b.v - a.v);
          }

          const chart = echarts.init(el);
          chart.setOption({
            backgroundColor: 'transparent',
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            grid: { left: 40, right: 16, top: 12, bottom: 44 },
            xAxis: {
              type: 'category',
              data: items.map(x => x.k),
              axisLabel: { color: 'rgba(231,234,242,.72)', rotate: 18 },
              axisLine: { lineStyle: { color: 'rgba(255,255,255,.12)' } },
            },
            yAxis: {
              type: 'value',
              axisLabel: { color: 'rgba(231,234,242,.72)' },
              splitLine: { lineStyle: { color: 'rgba(255,255,255,.08)' } },
            },
            series: [{
              name: title,
              type: 'bar',
              data: items.map(x => x.v),
              itemStyle: { color: 'rgba(110,231,255,.65)' }
            }]
          });
          return chart;
        };

        // market history charts (app.py style migration)
        const mh = Array.isArray(d?.market_history) ? d.market_history : [];
        const dates = mh.map(x => x.date);
        const mkLine = (el, y, title, color) => {
          if (!el) return null;
          const chart = echarts.init(el);
          chart.setOption({
            backgroundColor: 'transparent',
            grid: { left: 40, right: 16, top: 20, bottom: 32 },
            tooltip: { trigger: 'axis', axisPointer: { type: 'line' } },
            xAxis: { type: 'category', data: dates, axisLabel: { color: 'rgba(231,234,242,.72)', rotate: 20 } },
            yAxis: { type: 'value', axisLabel: { color: 'rgba(231,234,242,.72)' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,.08)' } } },
            series: [{ type: 'line', data: y, smooth: false, symbol: 'circle', symbolSize: 4, lineStyle: { width: 2, color }, itemStyle: { color } }]
          });
          return chart;
        };
        const mkLine2 = (el, s1, s2, n1, n2, c1, c2) => {
          if (!el) return null;
          const chart = echarts.init(el);
          chart.setOption({
            backgroundColor: 'transparent',
            grid: { left: 40, right: 16, top: 20, bottom: 32 },
            tooltip: { trigger: 'axis', axisPointer: { type: 'line' } },
            legend: { textStyle: { color: '#5c6b8a' } },
            xAxis: { type: 'category', data: dates, axisLabel: { color: '#5c6b8a', rotate: 20 } },
            yAxis: { type: 'value', axisLabel: { color: '#5c6b8a' }, splitLine: { lineStyle: { color: '#e5edff' } } },
            series: [
              { name: n1, type: 'line', data: s1, smooth: false, symbol: 'circle', symbolSize: 4, lineStyle: { width: 2, color: c1 }, itemStyle: { color: c1 } },
              { name: n2, type: 'line', data: s2, smooth: false, symbol: 'circle', symbolSize: 4, lineStyle: { width: 2, color: c2 }, itemStyle: { color: c2 } },
            ]
          });
          return chart;
        };

        const cTurn = mkLine($('#chart-mh-turnover'), mh.map(x => x['成交额']), '成交额', '#4c6ef5');
        const cAct  = mkLine($('#chart-mh-activity'), mh.map(x => x['活跃度']), '情绪指数', '#f39c12');
        const cFin  = mkLine($('#chart-mh-fin'), mh.map(x => x['融资净买入']), '融资净买入', '#16a085');
        const cUD   = mkLine2($('#chart-mh-updown'), mh.map(x => x['上涨']), mh.map(x => x['下跌']), '上涨家数', '下跌家数', '#22c55e', '#ef4444');
        const cLim  = mkLine2($('#chart-mh-limit'), mh.map(x => x['涨停']), mh.map(x => x['跌停']), '涨停数', '跌停数', '#ef4444', '#3b82f6');

        const mkK = (el, arr) => {
          if (!el) return null;
          if (!Array.isArray(arr) || !arr.length) return null;
          const dates = arr.map(x => x.date);
          const vals = arr.map(x => [x.open, x.close, x.low, x.high]);
          const chart = echarts.init(el);
          chart.setOption({
            backgroundColor: 'transparent',
            grid: { left: 30, right: 10, top: 10, bottom: 25 },
            xAxis: { type: 'category', data: dates, axisLabel: { show: false } },
            yAxis: { scale: true, axisLabel: { color: '#5c6b8a' }, splitLine: { lineStyle: { color: '#e5edff' } } },
            tooltip: { trigger: 'axis' },
            series: [{ type: 'candlestick', data: vals, itemStyle: { color: '#ef4444', color0: '#22c55e', borderColor: '#ef4444', borderColor0: '#22c55e' } }]
          });
          return chart;
        };

        const idx = d?.indices || {};
        const cIdxSh = mkK($('#chart-idx-sh'), idx.sh || []);
        const cIdxC = mkK($('#chart-idx-cyb'), idx.cyb || []);
        const cIdxK = mkK($('#chart-idx-kcb'), idx.kcb || []);

        let cGem = null;
        const gem = Array.isArray(d?.gem_pe) ? d.gem_pe : [];
        if ($('#chart-gem-pe')) {
          cGem = echarts.init($('#chart-gem-pe'));
          cGem.setOption({
            backgroundColor: 'transparent',
            grid: { left: 40, right: 16, top: 20, bottom: 32 },
            tooltip: { trigger: 'axis', axisPointer: { type: 'line' } },
            xAxis: { type: 'category', data: gem.map(x => x.date), axisLabel: { color: '#5c6b8a', rotate: 20 } },
            yAxis: { type: 'value', axisLabel: { color: '#5c6b8a' }, splitLine: { lineStyle: { color: '#e5edff' } } },
            series: [{ type: 'line', data: gem.map(x => x.pe), symbol: 'none', lineStyle: { width: 2, color: '#3b82f6' } }]
          });
        }

        window.addEventListener('resize', () => {
          cTurn && cTurn.resize(); cAct && cAct.resize(); cFin && cFin.resize(); cUD && cUD.resize(); cLim && cLim.resize();
          cIdxSh && cIdxSh.resize(); cIdxC && cIdxC.resize(); cIdxK && cIdxK.resize(); cGem && cGem.resize();
          cExBtc && cExBtc.resize(); cExXau && cExXau.resize(); cExUs10 && cExUs10.resize();
        }, { passive: true });
      }

      renderCharts();
    }, 0);

    return root;
  }

  function renderMarket() {
    const d = state.latest || {};
    const root = document.createElement('div');
    root.className = 'grid';

    const rangeDist = d?.market_overview?.range_distribution || [];
    const topTurn = d?.top_100_turnover || d?.top_turnover_100 || [];
    const topGain = d?.top_100_gainers || [];
    const topLoss = d?.top_100_losers || [];

    const overlap = (() => {
      const a = new Set(topTurn.map(x => String(x.ts_code || x.code || '')));
      const b = new Set(topGain.map(x => String(x.ts_code || x.code || '')));
      let c = 0;
      for (const x of a) if (b.has(x) && x) c++;
      return c;
    })();

    root.appendChild(card('市场全貌（含 Top100）', `
      <div class="muted">已合并 Top100 统计入口（去除 LLM 摘要，仅展示可复算统计与图表）。</div>
      <div class="muted" style="margin-top:8px;">样本：成交额Top100 ${topTurn.length}｜涨幅Top100 ${topGain.length}｜跌幅Top100 ${topLoss.length}｜成交额&涨幅交集 ${overlap}</div>
    `, 'card full'));

    root.appendChild(card('全市场涨跌幅分布', `
      <div id="chart-range-dist" style="height:280px;"></div>
    `, 'card half'));

    root.appendChild(card('成交额Top100 涨跌分类', `
      <div id="chart-top100-buckets" style="height:280px;"></div>
    `, 'card half'));

    root.appendChild(card('涨幅Top100-市值分层', `<div id="chart-gainer-cap" style="height:240px;"></div>`, 'card half'));
    root.appendChild(card('涨幅Top100-成交额分层', `<div id="chart-gainer-turn" style="height:240px;"></div>`, 'card half'));
    root.appendChild(card('涨幅Top100-板块分布', `<div id="chart-gainer-board" style="height:240px;"></div>`, 'card half'));
    root.appendChild(card('涨幅Top100-形态分布（含未归类）', `<div id="chart-gainer-pattern" style="height:240px;"></div>`, 'card half'));

    const mkRows = (arr, title) => {
      const rows = (arr || []).slice(0, 20).map((r, i) => {
        const name = r.name || '—';
        const code = r.ts_code || r.code || '—';
        const pct = r.pct_chg ?? r.pct;
        const amt = r.turnover_yi ?? (r.amount != null ? (Number(r.amount)/1e8).toFixed(2) : null);
        return `<tr><td>${i+1}</td><td>${name}</td><td class="muted">${code}</td><td>${pct==null?'—':Number(pct).toFixed(2)}%</td><td>${amt==null?'—':amt}亿</td></tr>`;
      }).join('');
      return card(title, `
        <div style="max-height:360px; overflow:auto;">
          <table>
            <thead><tr><th>#</th><th>名称</th><th>代码</th><th>涨跌幅</th><th>成交额</th></tr></thead>
            <tbody>${rows || '<tr><td colspan="5" class="muted">暂无数据</td></tr>'}</tbody>
          </table>
        </div>
      `, 'card third');
    };

    root.appendChild(mkRows(topTurn, '成交额Top100（前20）'));
    root.appendChild(mkRows(topGain, '涨幅Top100（前20）'));
    root.appendChild(mkRows(topLoss, '跌幅Top100（前20）'));

    setTimeout(() => {
      if (!window.echarts) return;

      const makeBar = (el, labels, values, colors=null) => {
        if (!el) return;
        const chart = echarts.init(el);
        chart.setOption({
          backgroundColor: 'transparent',
          grid: { left: 40, right: 16, top: 12, bottom: 52 },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
          xAxis: { type: 'category', data: labels, axisLabel: { color: 'rgba(231,234,242,.72)', rotate: 18 } },
          yAxis: { type: 'value', axisLabel: { color: 'rgba(231,234,242,.72)' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,.08)' } } },
          series: [{ type: 'bar', data: values, itemStyle: colors ? { color: (p)=>colors[p.dataIndex] } : { color: 'rgba(110,231,255,.65)' } }]
        });
        window.addEventListener('resize', () => chart.resize(), { passive: true });
      };

      // range distribution
      if (Array.isArray(rangeDist) && rangeDist.length) {
        const labels = rangeDist.map(x => x.label || '—');
        const values = rangeDist.map(x => Number(x.count || 0));
        const colors = rangeDist.map(x => (Number(x.bucket_start || 0) >= 0 ? 'rgba(251,113,133,.75)' : 'rgba(74,222,128,.75)'));
        makeBar($('#chart-range-dist'), labels, values, colors);
      } else {
        makeBar($('#chart-range-dist'), ['暂无数据'], [0]);
      }

      // top100 buckets
      const rows = Array.isArray(topTurn) ? topTurn : [];
      const pct = rows.map(r => Number(r.pct ?? r.pct_chg ?? NaN)).filter(v => !Number.isNaN(v));
      const cats = ['小涨(2-5%)','中涨(5-9%)','大涨(>9%)','小跌(-2~-5%)','中跌(-5~-9%)','大跌(<-9%)','震荡(-2~2%)'];
      const val = [0,0,0,0,0,0,0];
      for (const p of pct) {
        if (p >= 9) val[2]++;
        else if (p >= 5) val[1]++;
        else if (p >= 2) val[0]++;
        else if (p <= -9) val[5]++;
        else if (p <= -5) val[4]++;
        else if (p <= -2) val[3]++;
        else val[6]++;
      }
      makeBar($('#chart-top100-buckets'), cats, val);

      // gainer top100 2x2 analytics (PRD)
      const gRows = Array.isArray(topGain) ? topGain : [];
      const countBy = (arr, keyFn, order=null) => {
        const m = new Map();
        for (const r of arr) {
          const k = keyFn(r) || '未归类';
          m.set(k, (m.get(k) || 0) + 1);
        }
        let out = Array.from(m.entries()).map(([k,v]) => ({k,v}));
        if (order) out.sort((a,b)=>order.indexOf(a.k)-order.indexOf(b.k));
        return out;
      };
      const cap = countBy(gRows, r => r.cap_bucket, ['微盘','中盘','大盘','未归类']);
      const turn = countBy(gRows, r => r.turn_bucket, ['>10亿','3-10亿','<3亿','未归类']);
      const board = countBy(gRows, r => r.board, ['主板','创业板','科创板','未归类']);
      const pattern = countBy(gRows, r => (r.pattern && r.pattern !== '—') ? r.pattern : '未归类');

      makeBar($('#chart-gainer-cap'), cap.map(x=>x.k), cap.map(x=>x.v));
      makeBar($('#chart-gainer-turn'), turn.map(x=>x.k), turn.map(x=>x.v));
      makeBar($('#chart-gainer-board'), board.map(x=>x.k), board.map(x=>x.v));
      makeBar($('#chart-gainer-pattern'), pattern.map(x=>x.k), pattern.map(x=>x.v));
    }, 0);

    return root;
  }

  function renderShort() {
    const d = state.latest || {};
    const root = document.createElement('div');
    root.className = 'grid';

    const zt = d?.short_effect?.zt_pool || [];
    const dt = d?.short_effect?.dt_pool || [];
    const lh = d?.short_effect?.longhu || [];

    const parseStreak = (x) => {
      if (x == null) return null;
      const s = String(x);
      const m = s.match(/(\d+)/);
      if (m) return Number(m[1]);
      if (s.includes('首')) return 1;
      return null;
    };
    const ztStreak = zt.map(x => parseStreak(x.up_stat)).filter(x => x != null);
    const ztMax = ztStreak.length ? Math.max(...ztStreak) : 0;
    const ztLB = ztStreak.filter(x => x >= 2).length;
    const ztBroken = zt.filter(x => Number(x.open_times || 0) > 0).length;
    const ztBreakRate = zt.length ? (ztBroken / zt.length * 100) : 0;

    root.appendChild(card('4) 短线效应（涨停/跌停/龙虎榜）', `
      <div class="muted">龙虎榜：${lh.length} 条；涨停池：${zt.length} 条；跌停池：${dt.length} 条</div>
    `, 'card full'));

    const metrics = [
      {t:'连板股家数', v: ztLB},
      {t:'连板高度', v: ztMax},
      {t:'涨停炸板率', v: `${ztBreakRate.toFixed(1)}%`},
      {t:'炸板家数', v: ztBroken},
    ];
    for (const m of metrics) {
      const el = document.createElement('section');
      el.className = 'card kpi';
      el.innerHTML = `<h2>${m.t}</h2><div class="v">${m.v}</div>`;
      root.appendChild(el);
    }

    root.appendChild(card('连板高度-家数分布', `<div id="chart-zt-tier" style="height:260px;"></div>`, 'card half'));
    root.appendChild(card('连续跌停高度-家数分布', `<div id="chart-dt-tier" style="height:260px;"></div>`, 'card half'));

    const mkTable = (title, arr) => {
      const rows = (arr || []).slice(0, 20).map((r, i) => {
        const name = r.name || '—'; const code = r.ts_code || '—';
        const pct = r.pct_chg == null ? '—' : `${Number(r.pct_chg).toFixed(2)}%`;
        const net = r.net_amount == null ? '—' : Number(r.net_amount).toLocaleString('zh-CN');
        return `<tr><td>${i+1}</td><td>${name}</td><td class="muted">${code}</td><td>${pct}</td><td>${net}</td></tr>`;
      }).join('');
      return card(title, `<div style="max-height:360px;overflow:auto;"><table><thead><tr><th>#</th><th>名称</th><th>代码</th><th>涨跌幅</th><th>净额</th></tr></thead><tbody>${rows || '<tr><td colspan="5" class="muted">暂无数据</td></tr>'}</tbody></table></div>`, 'card third');
    };

    root.appendChild(mkTable('龙虎榜（前20）', lh));
    root.appendChild(mkTable('涨停池（前20）', zt));
    root.appendChild(mkTable('跌停池（前20）', dt));

    setTimeout(() => {
      if (!window.echarts) return;
      const countMap = (vals) => {
        const m = new Map();
        for (const v of vals) m.set(v, (m.get(v) || 0) + 1);
        return Array.from(m.entries()).sort((a,b)=>a[0]-b[0]);
      };
      const ztPairs = countMap(ztStreak);
      const dtPairs = countMap(dt.map(x => parseStreak(x.up_stat || x.cont_streak || x.open_times)).filter(x => x != null));
      const mkBar = (el, pairs, c) => {
        if (!el) return null;
        const ch = echarts.init(el);
        ch.setOption({
          backgroundColor: 'transparent', grid: { left: 40, right: 16, top: 20, bottom: 32 },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
          xAxis: { type: 'category', data: pairs.map(x => `${x[0]}板`), axisLabel: { color: '#5c6b8a' } },
          yAxis: { type: 'value', axisLabel: { color: '#5c6b8a' }, splitLine: { lineStyle: { color: '#e5edff' } } },
          series: [{ type: 'bar', data: pairs.map(x => x[1]), itemStyle: { color: c } }]
        });
        window.addEventListener('resize', ()=>ch.resize(), { passive: true });
        return ch;
      };
      mkBar($('#chart-zt-tier'), ztPairs, '#3b82f6');
      mkBar($('#chart-dt-tier'), dtPairs, '#22c55e');
    }, 0);

    return root;
  }

  function render() {
    const view = $('#view');
    view.innerHTML = '';
    view.appendChild(renderToday());
    view.appendChild(renderMarket());
    view.appendChild(renderShort());
  }

  async function boot() {
    const url = new URL(location.href);
    const date = url.searchParams.get('date');

    // date picker defaults
    const dp = $('#datepick');
    if (dp && date) dp.value = date;

    // Load button behavior per PRD:
    // 1) check trading day by trade_calendar.json
    // 2) check generated data exists in index.json
    const loadBtn = $('#btn-load');
    if (loadBtn) {
      loadBtn.addEventListener('click', async () => {
        const d = dp?.value;
        if (!d) return;

        const openDays = new Set((state.tradeCal?.open_days || []));
        if (openDays.size && !openDays.has(d)) {
          alert(`所选日期 ${d} 不是交易日`);
          return;
        }

        const dates = new Set((state.history?.dates || []));
        if (!dates.has(d)) {
          alert(`当天数据未生成，请等待`);
          return;
        }

        try {
          state.latest = await fetchJson(`./data/${d}.json`);
          $('#asof').textContent = `更新：${state.latest?.date ?? '—'}`;
          const u = new URL(location.href);
          u.searchParams.set('date', d);
          history.replaceState(null, '', u.toString());
          render();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch (e) {
          alert(`当天数据未生成，请等待`);
        }
      });
    }

    // Enter to load
    if (dp) {
      dp.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter') {
          ev.preventDefault();
          loadBtn?.click();
        }
      });
    }

    try {
      state.history = await fetchJson('./data/index.json');
    } catch (e) {
      state.history = { dates: [] };
    }

    try {
      state.tradeCal = await fetchJson('./data/trade_calendar.json');
    } catch (e) {
      state.tradeCal = { open_days: [] };
    }

    try {
      if (date) {
        state.latest = await fetchJson(`./data/${date}.json`);
      } else {
        state.latest = await fetchJson('./data/latest.json');
      }
      $('#asof').textContent = `更新：${state.latest?.date ?? '—'}`;
      if (dp && state.latest?.date && !dp.value) dp.value = state.latest.date;
    } catch (e) {
      state.latest = { date: null, conclusion: null, kpi: {}, top200: [] };
      $('#asof').textContent = '未找到数据（请先生成 data/latest.json）';
    }

    render();
  }

  boot();
</script>
</body>
</html>
